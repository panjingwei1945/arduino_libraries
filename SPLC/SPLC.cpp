#include "SPLC.h"
#include <avr/pgmspace.h>

const PROGMEM float _CALIB[] = {
// 79.137553,78.995916,79.976979,81.970114,83.516397,82.028054,81.331625,79.628082,81.066665,82.949156,80.288579,77.70098,82.665919,83.166013,86.026921,87.590511,88.705726,84.669508,87.595683,85.383578,86.953673,86.885741,87.082773,84.350488,83.751228,87.865532,89.317049,88.604705,85.766655,90.060984,90.61256,88.695459,87.879636,87.35588,84.395987,78.243624,87.49584,87.067587,88.135552,88.886787,91.251427,89.509896,88.214821,85.609515,86.046671,82.583544,82.974657,81.082203,81.03829,83.063172,84.769205,82.341512,84.106657,84.465524,83.859517,83.407355,81.638952,80.739528,84.102682,83.909226,80.42225,80.310076,83.139744,83.94747,83.710039,84.932755,86.484959,85.604398,83.645561,83.208534,80.970559,81.65754,83.112187,84.57918,81.846623,82.494029,81.213291,85.100321,85.287617,84.603968,80.87842,77.366324,77.821472,76.729905,75.571458,74.746027,79.818815,80.536257,82.282767,79.992754,79.657782,82.680176,80.505638,78.717873,76.309868,73.257019,70.960715,79.452976,80.107856,73.403901,73.656988,75.488607,82.633614,80.63202,69.937303,80.830037,77.010382,78.063019,80.794816,83.459071,83.882203,84.357142,85.427969,83.087271,84.321557,83.72074,83.108225,82.931664,76.473728,81.77925,80.847539,84.7636,81.237264,87.328894,87.212012,85.550858,88.35024,88.908234,86.658209,85.739643,86.368868,86.752958,86.690848,87.544613,87.408006,89.832341,88.44881,89.490237,89.444427,87.147857,87.067098,85.061598,86.07899,86.303404,85.035365,85.950757,85.785183,85.839875,87.296811,87.693872,86.997733,86.451929,85.965185,85.959742,81.769996,82.418191,85.548777,83.763842,85.839317,85.969831,85.014619,86.260495,84.644005,83.294699,84.751643,83.797881,82.939055,81.638358,82.904195,81.72273,80.554573,82.043273,84.649727,85.60114,84.893826,84.361845,81.132712,83.104478,79.267713,78.969524,82.124584,86.330932,85.650675,86.906185,88.309496,88.088252,89.149684,88.127945,86.005435,86.237972,85.172125,84.454022,86.844737,87.047406,89.356994,89.017817,89.031889,87.72231,87.458851,87.257354,85.505209,87.645184,85.883737,84.420322,83.183399,87.701482,90.386836,90.019652,87.836839,89.496457,89.193746,87.193127,84.462356,86.052169,85.572896,86.644283,85.919472,87.626663,86.264856,87.800618,86.059232,86.134281,85.71077,83.762588,84.989175,81.832276,82.22815,80.652206,82.233939,84.015624,85.790374,85.013685,86.494209,84.930246,84.281321,79.401748,80.986429,80.403791,78.878666,78.535691,81.199328,81.581425,82.857573,80.9686,83.700878,83.963097,81.644713,81.320434,77.005077,69.598302,65.571645,80.901405,82.005669,82.363835,80.641191,80.987353,82.756618,81.403956,81.796936,80.492179,80.337588,82.532641,83.397632,86.191357,84.998601,87.83448,89.540795,89.059532,87.907747,88.322939,88.724526,86.879713,83.804993,85.29806,86.395375,85.730834,87.508216,86.063819,87.942294,87.625313,88.535981,87.380983,84.155704,85.785727,81.849387,82.960181,83.163512,84.232443,85.737558,85.216063,86.300474,86.329593,84.091732,83.966681,83.427549,83.179872,81.07306,79.527087,80.613334,81.545988,83.221771,83.795727,83.113922,83.079061,80.534989,80.459731,78.35549,77.344813,75.806802,75.620166,79.456171,74.391588,75.438711,73.457613,78.477616,80.737734,79.086616,76.030563,78.088271,73.239505,78.969392,74.201111,75.304714,76.677951,76.841149,78.777129,74.467024,73.520563,77.417775,79.460351,76.233487,73.788285,63.208947,62.132079,66.31267,72.976319,71.021628,75.905852,76.770472,70.534193,72.111593,72.917709,73.260684,53.868074,71.505758,73.283173,76.886709,76.837759,74.356498,73.127938,78.859299,77.955423,74.307504,77.603068,76.430695,73.298372,71.314165,76.621044,71.119606,74.578516,75.216409,74.33341,70.908313,71.796693,73.193188,72.709742,72.323107,71.860115,66.711625,72.349668

// This calibration data is measured with Mic Position3, and median filtered with window of 10. 
// The sound pressure level produced would be only approximate to the specified.
77.5419,77.9179,78.8384,80.2980,81.1066,83.4026,85.4387,85.4387,85.4387,85.4387,85.4387,85.8414,85.7519,86.1569,86.1569,86.6552,86.7355,87.8285,88.9026,89.0012,89.1352,89.6098,89.6098,89.6098,89.5792,89.4065,88.9900,88.8044,88.8044,88.8044,89.0270,88.7931,88.7931,88.7015,88.4970,88.4363,88.4363,88.1167,87.4786,86.8405,86.5606,86.2149,85.7378,85.1303,84.2434,83.0676,82.2736,81.4002,80.8209,80.8209,80.8209,80.8209,80.8209,81.7992,82.5413,82.5413,82.5413,82.5413,82.5413,81.9952,80.3603,79.6156,79.0978,78.7524,78.7524,78.7524,79.0978,79.6156,79.6156,79.4663,79.2702,78.1554,78.1554,79.1441,79.1441,79.1441,77.0138,76.2293,75.9219,75.1160,74.2255,74.9635,74.9635,74.2255,74.2255,72.9233,74.2255,74.9635,75.7261,76.8136,76.8136,76.8136,73.7531,77.0039,77.9842,78.5579,79.0667,79.6456,79.9187,81.9938,83.4990,84.3040,84.8587,84.9070,85.1710,85.4599,86.0650,86.8630,87.0058,87.3603,87.3603,87.1510,87.4616,87.4616,87.4616,87.2051,87.4616,87.4616,87.4616,87.4616,87.4616,87.3726,87.0938,86.9227,86.9227,86.4970,85.8336,85.6456,85.2378,85.2141,84.8520,84.6788,84.2226,83.7638,83.7292,83.4929,83.4929,83.2427,82.8357,82.0436,81.4662,80.2228,79.2212,78.9341,78.5162,76.0373,73.1565,73.1565,76.3645,78.9341,79.1305,80.5012,80.5712,81.7102,81.9265,81.9265,81.9265,81.9265,81.9265,81.4396,80.7695,80.0265,79.8072,78.6191,77.1743,76.2193,76.2193,76.1919,76.1919,76.1919,75.3926,75.3926,75.4026,76.0156,77.5314,78.5012,78.8649,80.8315,81.6113,81.6113,81.6113,82.0063,82.4087,82.4087,82.4087,80.5247,80.1785,78.5252,78.5252,78.5833,78.5833,78.3896,77.0686,77.0686,78.3896,78.6275,78.6275,78.9695,80.6748,82.7600,83.6621,83.7082,84.9045,84.9045,85.9199,85.9199,86.1710,85.9199,85.3259,84.6959,84.6959,85.2009,85.2009,85.7949,86.5038,87.5247,88.1824,88.9321,89.1827,89.1827,89.1827,89.1827,89.0779,89.0779,89.0779,89.0779,89.2045,89.4228,89.6563,89.6563,89.6563,89.7281,89.8066,89.7369,89.6894,89.5866,89.3266,88.8985,88.6425,88.6425,88.6063,88.1245,87.3553,86.7203,86.3159,86.0034,86.0034,86.3900,86.4329,85.9272,85.8424,85.6322,85.3860,85.3860,85.3860,84.4377,83.0388,81.0992,79.4094,76.9695,76.3596,76.3596,76.3596,78.6523,79.4094,79.9671,80.9601,80.9601,80.9601,81.7238,81.7238,81.7238,81.1459,80.3320,79.4313,78.5606,78.5606,79.3774,79.3774,78.5606,77.4333,78.5606,78.5606,78.0918,79.3526,80.9042,81.6929,81.6929,81.6929,82.1650,83.2828,83.2828,83.2828,84.0178,84.1138,84.0784,83.7015,83.7015,84.0207,84.1543,83.7715,84.3655,84.7548,84.3655,83.7715,83.7715,84.2894,84.5620,84.4020,84.4020,84.5620,84.4020,84.1033,84.1033,84.1033,84.1033,83.1565,82.7557,82.4698,82.0865,81.0827,80.3393,80.3393,80.4749,81.1746,81.1746,80.4901,80.0979,79.5108,79.6640,79.9796,80.4901,80.6662,80.6662,79.9796,79.2791,79.2791,79.2791,79.2062,78.3177,77.5903,77.5903,77.5903,77.5903,77.1188,76.7281,76.3703,76.3703,76.3703,75.8327,74.4223,73.0666,72.6809,72.1489,71.7952,69.6772,69.6772,71.9692,72.3272,70.9371,70.9371,71.6842,72.1719,72.1719,72.1719,73.7341,72.1719,71.0282,70.2811,70.0183
};

const float f0 = 3100;
const float df = 100;
const float calib_vol = 192;


int SPLCClass::get_D_SPL(float fq, byte DB){
	int index = (int)((fq - f0)/df);
	float real_SPL = pgm_read_float_far(&_CALIB[index]);
	float att = real_SPL-DB;
	return (int)(calib_vol - (2 * att));
}

void SPLCClass::init(){
	NOP();
}

SPLCClass SPLC;


